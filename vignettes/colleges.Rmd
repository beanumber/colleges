---
title: "Colleges"
author: "Ben Baumer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

```{r, message=FALSE}
library(tidyverse)
library(colleges)
```

## Integrity checks

```{r}
ncaa %>%
  group_by(Year) %>%
  summarize(N = n(), num_schools = n_distinct(school_name),
            num_bball = sum(!is.na(bball_wins)),
            num_fball = sum(!is.na(fball_wins)),
            num_military = sum(is_military),
            num_public = sum(!is.na(is_private)),
            num_fees = sum(!is.na(comp_fee_out_state)),
            num_act = sum(!is.na(act_composite_75)),
            num_sat = sum(!is.na(sat_75_avg)))
```


```{r}
ncaa_summary <- ncaa %>%
  group_by(school_name) %>%
  summarize(num_years = n(), 
            avg_ugrads = mean(ugrads, na.rm = TRUE),
            bball_wpct = sum(bball_wins) / sum(bball_wins + bball_losses),
            fball_wpct = sum(fball_wins) / sum(fball_wins + fball_losses),
            bball_revenue = sum(bball_revenue, na.rm = TRUE) / 1e6,
            fball_revenue = sum(fball_revenue, na.rm = TRUE) / 1e6) %>%
  mutate(bball_rev_per_ugrad = bball_revenue / avg_ugrads,
         fball_rev_per_ugrad = fball_revenue / avg_ugrads)
```

## Biggest schools

```{r}
ncaa_summary %>%
  arrange(desc(avg_ugrads))
```


## Basketball schools

```{r}
ncaa_summary %>%
  arrange(desc(bball_wpct))
ncaa_summary %>%
  arrange(desc(bball_revenue))
```

## Football schools

```{r}
ncaa_summary %>%
  arrange(desc(fball_wpct))
ncaa_summary %>%
  arrange(desc(fball_revenue))
```

## Best fundraisers

```{r}
ncaa_summary %>%
  select(-fball_revenue) %>%
  arrange(desc(bball_rev_per_ugrad))
ncaa_summary %>%
  select(-bball_revenue, -bball_rev_per_ugrad) %>%
  arrange(desc(fball_rev_per_ugrad))
```

## Correlations

```{r}
ncaa_summary %>%
  summarize(cor_cross_wpct = cor(bball_wpct, fball_wpct, use = "complete.obs"),
            cor_cross_rev = cor(bball_revenue, fball_revenue),
            cor_bball = cor(bball_wpct, bball_revenue),
            cor_fball = cor(fball_wpct, fball_revenue, use = "complete.obs"),
            cor_size = cor(avg_ugrads, fball_revenue, use = "complete.obs"))
```

military academies

```{r}
qplot(data = ncaa, x = dollars_per_capita, geom = "density")
ggplot(data = ncaa, aes(y = yield, x = log(dollars_per_capita + 1))) + 
  geom_point() +
  facet_wrap(~Year)

ggplot(data = ncaa, aes(x = Year, y = yield, group = school_name)) + 
  geom_line()

ggplot(data = ncaa, aes(x = Year, y = admit_rate, group = school_name)) + 
  geom_line()
```

Long-term trends

```{r}
ncaa %>%
  group_by(Year) %>%
  summarize(total_applications = sum(applied, na.rm = TRUE), 
            total_admits = sum(admitted, na.rm = TRUE), 
            total_enrolled = sum(enrolled, na.rm = TRUE), 
            cor_sport = cor(bball_wpct, fball_wpct, use = "complete.obs"), 
            sat_25 = mean(sat_25_avg, na.rm = TRUE),
            sat_75 = mean(sat_75_avg, na.rm = TRUE),
#            act_25 = mean(P25ACT, na.rm = TRUE),
            act_75 = mean(act_composite_75, na.rm = TRUE)) %>%
  mutate(admit_rate = total_admits / total_applications, 
         yield = total_enrolled / total_admits)
```

```{r}
ncaa %>%
  mutate(sat_range = cut(sat_75_avg, breaks = seq(500, 800, by = 50))) %>%
  ggplot(aes(x = Year, y = sat_75_avg)) + 
    geom_line(aes(group = school_name)) + 
    facet_wrap(~sat_range, scales = "free_y")
```

```{r}
mod <- lm(admit_rate ~ Year + school_name, data = ncaa)
summary(mod)
```
